<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente B - Prot√≥tipo</title>
  <style>
    :root {
      --bg-gradient-start: #0f172a;
      --bg-gradient-end:   #1e293b;
      --primary:           #4f46e5;
      --primary-dark:      #4338ca;
      --primary-soft:      #e0e7ff;
      --secondary:         #e5e7eb;
      --text-main:         #0f172a;
      --text-muted:        #6b7280;
      --card-bg:           #ffffff;
      --border-soft:       #e5e7eb;
      --shadow-soft:       0 20px 35px rgba(15, 23, 42, 0.25);
      --radius-lg:         18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left, #312e81, transparent 60%),
                  radial-gradient(circle at bottom right, #0ea5e9, transparent 55%),
                  linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      background-attachment: fixed;
      color: var(--text-main);
    }

    /* CENTRALIZA O CONTE√öDO EM MOBILE E DESKTOP */
    #app-wrapper {
      width: 100%;
      max-width: 960px;
    }

    /* CARD BASE (LANDING E CHAT) */
    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 24px 20px;
      margin: 0 auto;
    }

    /* LANDING */
    #landing {
      max-width: 620px;
      text-align: center;
      margin: 0 auto 16px auto;
    }
    #landing h1 {
      font-size: 26px;
      margin-bottom: 8px;
      color: var(--text-main);
    }
    #landing p {
      font-size: 15px;
      color: var(--text-muted);
      margin-bottom: 12px;
      line-height: 1.5;
    }
    #btnStartChat {
      padding: 11px 26px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }
    #btnStartChat:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 16px 28px rgba(79, 70, 229, 0.55);
    }
    #btnStartChat:active {
      transform: translateY(1px);
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.35);
    }

    /* CHAT CONTAINER */
    #container {
      max-width: 960px;
      margin: 0 auto;
      display: none; /* aparece s√≥ depois do "Come√ßar conversa" */
    }

    #container h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
      color: var(--text-main);
    }
    #container p.subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0 0 10px 0;
      line-height: 1.4;
    }

    #chat {
      height: 320px;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 8px;
      overflow-y: auto;
      background: #f9fafb;
      font-size: 14px;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }
    .msg {
      margin: 6px 0;
    }
    .msg-user {
      text-align: right;
      color: #1d4ed8;
    }
    .msg-bot {
      text-align: left;
      color: #111827;
    }
    .msg span.role {
      font-weight: 600;
      display: block;
      margin-bottom: 1px;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
    }

    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.08s ease, transform 0.08s ease, box-shadow 0.08s ease;
    }
    button.primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
    }
    button.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    button.primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(79, 70, 229, 0.3);
    }
    button.secondary {
      background: var(--secondary);
      color: var(--text-main);
    }
    button.secondary:hover {
      background: #d1d5db;
    }

    .actions-row,
    .voice-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    #upload-section {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border-soft);
      font-size: 13px;
    }
    #upload-section strong {
      display: block;
      margin-bottom: 4px;
      color: var(--text-main);
    }
    #file {
      font-size: 13px;
      margin: 4px 0 6px 0;
    }

    #status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MOBILE AJUSTES */
    @media (max-width: 640px) {
      body {
        padding: 10px;
        align-items: flex-start;
      }
      #landing,
      #container .card {
        padding: 18px 14px;
      }
      #landing h1 {
        font-size: 22px;
      }
      #container h1 {
        font-size: 18px;
      }
      #chat {
        height: 260px;
      }
      .actions-row,
      .voice-row {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .actions-row button,
      .voice-row button {
        flex: 1 1 calc(50% - 4px);
        text-align: center;
      }
      #btnStartChat {
        width: 100%;
      }
    }

    /* TELAS MUITO GRANDES */
    @media (min-width: 1024px) {
      #landing,
      #container .card {
        padding: 28px 28px;
      }
    }
  </style>
</head>
<body>
  <div id="app-wrapper">
    <!-- LANDING / HOME -->
    <div id="landing" class="card">
      <h1>Agente B.</h1>
      <p>
        Ol√°, Esta √© a sua agente pessoal.<br>
        Ela l√™ textos e PDFs, responde perguntas, conversa por voz e ainda fala em portugu√™s com voc√™.
      </p>
      <p>
        Clique abaixo para iniciar a conversa:
      </p>
      <button id="btnStartChat">Come√ßar conversa</button>
    </div>

    <!-- CHAT / APP -->
    <div id="container">
      <div class="card">
        <h1>Agente B ‚Äì agente inteligente</h1>
        <p class="subtitle">
          Voc√™ pode:
          <br>- Enviar uma pergunta ou comando para a Bruner.
          <br>- Fazer upload de um arquivo de texto ou PDF para ela ler.
          <br>- Ouvir em voz alta a √∫ltima resposta.
          <br>- Falar no microfone e conversar por √°udio.
        </p>

        <div id="chat"></div>

        <textarea id="input" rows="3" placeholder="Digite sua pergunta, pedido de informa√ß√£o ou comando..."></textarea>

        <div class="actions-row">
          <button id="send" class="primary">Enviar Texto</button>
          <button id="speak" class="secondary">Ouvir (navegador)</button>
          <button id="speak-ia" class="secondary">Ouvir √°udio IA</button>
          <button id="toggle-ia" class="secondary">Play / Pause IA</button>
        </div>

        <div class="voice-row">
          <button id="start-rec" class="secondary">üéôÔ∏è Gravar √°udio (voz)</button>
          <button id="stop-rec" class="secondary" disabled>Enviar Audio</button>
        </div>

        <div id="upload-section">
          <strong>Upload de arquivo de texto</strong>
          <input
            type="file"
            id="file"
            accept=".txt,.md,.csv,.json,.log,.pdf,image/*"
          />
          <br />
          <button id="upload" class="secondary">Enviar arquivo</button>
        </div>

        <div id="status"></div>
      </div>
    </div>
  </div>

  <script>
    // Landing -> Chat
    const landingEl = document.getElementById('landing');
    const appContainerEl = document.getElementById('container');
    document.getElementById('btnStartChat').addEventListener('click', () => {
      landingEl.style.display = 'none';
      appContainerEl.style.display = 'block';
    });

    // ID √∫nico por navegador, salvo no localStorage
    let clientId = localStorage.getItem('agentClientId');
    if (!clientId) {
      clientId = 'client-' + Math.random().toString(36).slice(2);
      localStorage.setItem('agentClientId', clientId);
    }

    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const statusEl = document.getElementById('status');

    let ultimaResposta = "";
    let iaAudio = null; // guarda o √°udio gerado pela IA
    let navegadorUtterance = null; // fala do navegador

    function adicionarMensagem(tipo, texto) {
      const linha = document.createElement('div');
      linha.className = 'msg ' + (tipo === 'user' ? 'msg-user' : 'msg-bot');

      const roleSpan = document.createElement('span');
      roleSpan.className = 'role';
      roleSpan.textContent = tipo === 'user' ? 'Paulo:' : 'Agente B:';

      const textoSpan = document.createElement('span');
      textoSpan.textContent = texto;

      linha.appendChild(roleSpan);
      linha.appendChild(textoSpan);

      chatEl.appendChild(linha);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function enviarMensagem() {
      const msg = inputEl.value.trim();
      if (!msg) return;

      adicionarMensagem('user', msg);
      inputEl.value = '';
      statusEl.textContent = 'Enviando mensagem para a Bruner...';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, client_id: clientId })
        });

        if (!res.ok) throw new Error('Erro na resposta do servidor.');

        const data = await res.json();
        const reply = data.reply || '(sem resposta)';
        ultimaResposta = reply;
        adicionarMensagem('bot', reply);
        statusEl.textContent = 'Resposta recebida.';

        // FALA AUTOM√ÅTICA da resposta
        await ouvirUltimaRespostaIA();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao se comunicar com o servidor.';
      }
    }

    async function enviarArquivo() {
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];

      if (!file) {
        alert('Escolha um arquivo de texto primeiro.');
        return;
      }

      statusEl.textContent = 'Enviando arquivo para o servidor...';

      const formData = new FormData();
      formData.append('file', file);
      formData.append('client_id', clientId); // <- ESSENCIAL!

      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error('Erro na resposta do servidor ao enviar arquivo.');

        const data = await res.json();

        if (data.error) {
          statusEl.textContent = 'Erro: ' + data.error;
          return;
        }

        const nome = data.filename || file.name;
        const preview = data.preview || '(sem pr√©via)';
        const resumo = data.summary || '(n√£o foi poss√≠vel gerar resumo)';

        adicionarMensagem('user', 'Enviei o arquivo: ' + nome);
        adicionarMensagem(
          'bot',
          'Li o arquivo "' + nome + '".\n\nPr√©via do conte√∫do:\n' +
          preview + '\n\nResumo gerado pela Bruner:\n' + resumo
        );

        ultimaResposta = resumo;
        statusEl.textContent = 'Arquivo processado e resumo gerado.';

        // opcional: j√° falar o resumo
        await ouvirUltimaRespostaIA();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao enviar arquivo.';
      }
    }

    // ========================
    // Leitura pelo NAVEGADOR
    // ========================
    function ouvirUltimaResposta() {
      if (!ultimaResposta) {
        alert('Ainda n√£o h√° nenhuma resposta para ler.');
        return;
      }

      if (!('speechSynthesis' in window)) {
        alert('Seu navegador n√£o suporta leitura de texto via s√≠ntese de voz.');
        return;
      }

      // Cancela qualquer fala anterior
      window.speechSynthesis.cancel();

      navegadorUtterance = new SpeechSynthesisUtterance(ultimaResposta);
      navegadorUtterance.lang = 'pt-BR';
      navegadorUtterance.rate = 1;
      navegadorUtterance.pitch = 1;

      navegadorUtterance.onstart = () => {
        statusEl.textContent = 'Lendo com voz do navegador...';
      };
      navegadorUtterance.onend = () => {
        statusEl.textContent = 'Leitura (navegador) finalizada.';
      };

      window.speechSynthesis.speak(navegadorUtterance);
    }

    // ========================
    // Leitura pela IA (TTS)
    // ========================
    async function ouvirUltimaRespostaIA() {
      if (!ultimaResposta) {
        alert('Ainda n√£o h√° nenhuma resposta para ler.');
        return;
      }

      statusEl.textContent = 'Gerando √°udio com voz da Bruner (IA)...';

      try {
        const res = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: ultimaResposta })
        });

        if (!res.ok) throw new Error('Erro ao gerar √°udio.');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Se j√° existia um √°udio, para e libera
        if (iaAudio) {
          iaAudio.pause();
          URL.revokeObjectURL(iaAudio.src);
          iaAudio = null;
        }

        iaAudio = new Audio(url);
        iaAudio.onended = () => {
          statusEl.textContent = '√Åudio da Bruner finalizado.';
          document.getElementById('toggle-ia').textContent = 'Play / Pause IA';
        };
        iaAudio.play();

        statusEl.textContent = 'Reproduzindo √°udio (IA).';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao gerar √°udio com a IA.';
      }
    }

    function toggleAudioIA() {
      if (!iaAudio) {
        alert('Nenhum √°udio IA foi gerado ainda. Clique primeiro em "Gerar √°udio IA" ou aguarde a resposta autom√°tica.');
        return;
      }

      const toggleBtn = document.getElementById('toggle-ia');

      if (iaAudio.paused) {
        iaAudio.play();
        statusEl.textContent = 'Reproduzindo √°udio (IA).';
        toggleBtn.textContent = 'Pausar IA';
      } else {
        iaAudio.pause();
        statusEl.textContent = '√Åudio IA pausado.';
        toggleBtn.textContent = 'Play / Pause IA';
      }
    }

    // ========================
    // GRAVA√á√ÉO DE VOZ (STT)
    // ========================
    let mediaRecorder = null;
    let audioChunks = [];

    async function iniciarGravacao() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Seu navegador n√£o suporta grava√ß√£o de √°udio.');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = enviarAudioParaServidor;

        mediaRecorder.start();
        statusEl.textContent = 'Gravando... fale com a Bruner agora.';
        document.getElementById('start-rec').disabled = true;
        document.getElementById('stop-rec').disabled = false;
      } catch (err) {
        console.error(err);
        alert('Erro ao acessar o microfone.');
      }
    }

    function pararGravacao() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        statusEl.textContent = 'Processando √°udio...';
        document.getElementById('start-rec').disabled = false;
        document.getElementById('stop-rec').disabled = true;
      }
    }

    async function enviarAudioParaServidor() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });

      const formData = new FormData();
      formData.append('audio', blob, 'gravacao.webm');
      formData.append('client_id', clientId);

      try {
        const res = await fetch('/api/stt', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error('Erro ao enviar √°udio para o servidor.');

        const data = await res.json();

        if (data.error) {
          statusEl.textContent = 'Erro: ' + data.error;
          return;
        }

        const userText = data.user_text || '(n√£o reconhecido)';
        const replyText = data.reply_text || '(sem resposta)';

        adicionarMensagem('user', userText);
        adicionarMensagem('bot', replyText);

        ultimaResposta = replyText;
        statusEl.textContent = 'Resposta de voz processada.';

        // Fala autom√°tica da resposta de voz
        await ouvirUltimaRespostaIA();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao processar √°udio.';
      }
    }

    // ========================
    // EVENT LISTENERS
    // ========================

    document.getElementById('send').addEventListener('click', enviarMensagem);
    document.getElementById('upload').addEventListener('click', enviarArquivo);
    document.getElementById('speak').addEventListener('click', ouvirUltimaResposta);
    document.getElementById('speak-ia').addEventListener('click', ouvirUltimaRespostaIA);
    document.getElementById('toggle-ia').addEventListener('click', toggleAudioIA);

    document.getElementById('start-rec').addEventListener('click', iniciarGravacao);
    document.getElementById('stop-rec').addEventListener('click', pararGravacao);

    // Enter envia, Shift+Enter quebra linha
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
      }
    });
  </script>
</body>
</html>
